<!-- admin-dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    table { width:100%; border-collapse:collapse; margin-bottom:20px; }
    th, td { border:1px solid #ddd; padding:8px; }
    th { background:#333; color:#fff; }
    .btn-save, .btn-del { padding:6px 10px; border:none; cursor:pointer; border-radius:4px; }
    .btn-save { background:#27ae60; color:#fff; }
    .btn-del { background:#e74c3c; color:#fff; }
  </style>
</head>
<body>
  <h1>üöÄ Admin Dashboard</h1>

  <section>
    <h2>Live Analytics</h2>
    <p>Total Visits: <span id="total-visits">0</span></p>
    <p>Today‚Äôs Visits: <span id="today-visits">0</span></p>
    <p>Active Now: <span id="active-users">0</span></p>
  </section>

  <section>
    <h2>Trending Bot Brain</h2>
    <table id="trending-table">
      <tr><th>Question</th><th>Answer</th><th>Hits</th><th>Actions</th></tr>
    </table>
  </section>

  <section>
    <h2>Pending Suggestions</h2>
    <div id="review-container"></div>
  </section>

  <section>
    <h2>User Activity Log</h2>
    <table id="user-list-table">
      <tr><th>Name</th><th>Email</th><th>Visits</th><th>Last Seen</th></tr>
    </table>
  </section>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection, addDoc, getDoc, getDocs, deleteDoc, doc, updateDoc,
      serverTimestamp, query, orderBy, limit, where, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    // --- 1. DASHBOARD INITIALIZATION ---
    window.addEventListener('DOMContentLoaded', () => {
      console.log("Admin Dashboard Connecting... üöÄ");
      initDashboard();
    });

    function initDashboard() {
      trackLiveStats();
      loadUsers();
      loadBrainData();
      loadPending();
    }

    // --- 2. LIVE ANALYTICS ---
    function trackLiveStats() {
      const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
      const activeTime = new Date(Date.now() - 5 * 60000);

      onSnapshot(collection(db, "analytics"), snap => {
        document.getElementById("total-visits").innerText = snap.size;
      });

      const todayQ = query(collection(db, "analytics"), where("timestamp", ">=", startOfToday));
      onSnapshot(todayQ, snap => {
        document.getElementById("today-visits").innerText = snap.size;
      });

      const activeQ = query(collection(db, "analytics"), where("timestamp", ">=", activeTime));
      onSnapshot(activeQ, snap => {
        document.getElementById("active-users").innerText = snap.size;
      });
    }

    // --- 3. BOT BRAIN MANAGEMENT ---
    function renderBrainRow(id, data) {
      const currentAns = data.answers?.[0] || "";
      return `
        <tr>
          <td><b>${data.question}</b></td>
          <td><input type="text" value="${currentAns}" id="ans-${id}" class="edit-input"></td>
          <td style="text-align:center;">${data.hitCount || 0}</td>
          <td>
            <button onclick="window.updateBotAnswer('${id}')" class="btn-save">Update ‚úÖ</button>
            <button onclick="window.deleteFromBrain('${id}')" class="btn-del">üóëÔ∏è</button>
          </td>
        </tr>`;
    }

    function loadBrainData() {
      const table = document.getElementById("trending-table");
      const q = query(collection(db, "brain"), orderBy("hitCount", "desc"), limit(15));
      onSnapshot(q, snap => {
        if (!table) return;
        table.innerHTML = "<tr><th>Question</th><th>Answer</th><th>Hits</th><th>Actions</th></tr>";
        snap.forEach(d => {
          table.innerHTML += renderBrainRow(d.id, d.data());
        });
      });
    }

    window.updateBotAnswer = async (id) => {
      const newAns = document.getElementById(`ans-${id}`).value;
      if (!newAns) return alert("Answer cannot be empty!");
      try {
        await updateDoc(doc(db, "brain", id), {
          answers: [newAns.trim()],
          timestamp: serverTimestamp()
        });
        alert("Bot intelligence updated! üß†");
      } catch (e) { console.error(e); }
    };

    window.deleteFromBrain = async (id) => {
      if (confirm("Permanently delete from brain?")) {
        await deleteDoc(doc(db, "brain", id));
      }
    };

    // --- 4. APPROVAL SYSTEM ---
    function loadPending() {
      const container = document.getElementById("review-container");
      onSnapshot(collection(db, "temp_learning"), snap => {
        if (!container) return;
        container.innerHTML = snap.empty ? "<p style='padding:20px; color:#888;'>No pending reviews. üïäÔ∏è</p>" : "";
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          const card = document.createElement("div");
          card.style = "background:#fffbe6; padding:15px; border-radius:8px; border-left:5px solid #f1c40f; margin-bottom:15px;";
          card.innerHTML = `
            <p style="font-size:11px; color:#999;">USER SUGGESTION</p>
            <p><b>Q:</b> ${data.question}</p>
            <p><b>A:</b> <span style="color:#075e54">${data.answer}</span></p>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <button onclick="window.approveLearning('${id}')" style="background:#27ae60; color:#fff; border:none; padding:8px; border-radius:4px; flex:1; cursor:pointer;">Approve ‚úÖ</button>
              <button onclick="window.rejectLearning('${id}')" style="background:#e74c3c; color:#fff; border:none; padding:8px; border-radius:4px; flex:1; cursor:pointer;">Reject ‚ùå</button>
            </div>`;
          container.appendChild(card);
        });
      });
    }

    window.approveLearning = async (id) => {
      const docRef = doc(db, "temp_learning", id);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const d = snap.data();
        await addDoc(collection(db, "brain"), {
          question: d.question.toLowerCase(),
          answers: [d.answer],
          hitCount: 1,
          timestamp: serverTimestamp()
        });
        await deleteDoc(docRef);
        alert("Approved! Added to Brain. ‚ú®");
      }
    };

    window.rejectLearning = async (id) => {
      if (confirm("Delete this suggestion?")) {
        await deleteDoc(doc(db, "temp_learning", id));
      }
    };

    // --- 5. USER ACTIVITY LOG ---
    function loadUsers() {
      const table = document.getElementById("user-list-table");
      onSnapshot(query(collection(db, "users_list"), orderBy("lastSeen", "desc")), snap => {
        if (!table) return;
        table.innerHTML = "<tr><th>Name</th><th>Email</th><th>Visits</th><th>Last Seen</th></tr>";
        snap.forEach(d => {
          const u = d.data();
          table.innerHTML += `
            <tr>
              <td>${u.name || 'User'}</td>
              <td>${u.email || 'N/A'}</td>
              <td>${u.visitCount || 1}</td>
              <td>${u.lastSeen ? new Date(u.lastSeen).toLocaleString() : 'N/A'}</td>
            </tr>`;
        });
      });
    }
  </script>
</body>
</html>
